{% extends 'admin/admin_layout.html' %}

{% block title %}编辑密码 - 服务器密码管理系统{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- 页面标题 -->
        <div class="page-header mb-4" align="center">
            <h1 class="h3">更新服务器密码信息</h1>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form id="editPasswordForm">
                            <input type="hidden" id="passwordId">
                            <div class="mb-3">
                                <label for="innerIp" class="form-label">IP <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="innerIp" required>
                                <div class="invalid-feedback">请输入IP地址</div>
                            </div>
                            <div class="mb-3">
                                <label for="port" class="form-label">端口 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="port" required>
                                <div class="invalid-feedback">请输入端口号</div>
                            </div>
                            <div class="mb-3">
                                <label for="username" class="form-label">普通用户</label>
                                <input type="text" class="form-control" id="username">
                            </div>
                            <div class="mb-3">
                                <label for="userPass" class="form-label">普通用户密码</label>
                                <input type="text" class="form-control" id="userPass">
                            </div>
                            <div class="mb-3">
                                <label for="rootPass" class="form-label">管理员root密码 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="rootPass" required>
                            </div>
                            <div class="mb-3">
                                <label for="outerIp" class="form-label">备注</label>
                                <input type="text" class="form-control" id="outerIp">
                            </div>
                            <div class="d-flex gap-2 justify-content-center">
                                <button type="button" class="btn btn-primary" id="updatePasswordBtn">
                                    <i class="bi bi-save"></i> 更新
                                </button>
                                <a href="/password_admin" class="btn btn-secondary">
                                    <i class="bi bi-x"></i> 返回
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 从URL获取密码ID
        const urlParams = new URLSearchParams(window.location.search);
        const passwordId = urlParams.get('id');
        
        if (passwordId) {
            document.getElementById('passwordId').value = passwordId;
            
            // 加载密码信息
            fetch(`/api/passwords/${passwordId}`)
                .then(response => response.json())
                .then(password => {
                    document.getElementById('innerIp').value = password.inner_ip;
                    document.getElementById('port').value = password.port;
                    document.getElementById('username').value = password.username;
                    document.getElementById('userPass').value = password.user_password;
                    document.getElementById('rootPass').value = password.root_password;
                    document.getElementById('outerIp').value = password.outer_ip;
                })
                .catch(error => {
                    console.error('获取密码信息失败:', error);
                    showAlert('获取密码信息失败', 'danger');
                });
        }
        
        document.getElementById('updatePasswordBtn').addEventListener('click', async function() {
            // 表单验证逻辑（只验证IP、端口和管理员密码字段）
            let isValid = true;
            const requiredFields = document.querySelectorAll('#innerIp, #port, #rootPass');
            
            requiredFields.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                showAlert('请填写所有必填字段', 'warning');
                return;
            }
            
            const btn = this;
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 保存中...';
                
                const passwordId = document.getElementById('passwordId').value;
                const formData = {
                    inner_ip: document.getElementById('innerIp').value,
                    port: document.getElementById('port').value,
                    username: document.getElementById('username').value,
                    user_password: document.getElementById('userPass').value,
                    root_password: document.getElementById('rootPass').value,
                    outer_ip: document.getElementById('outerIp').value
                };
                
                const response = await fetch(`/api/passwords/${passwordId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    // 存储修改记录的ID，以便在密码列表页标记为新增
                    localStorage.setItem(`new_password_${passwordId}`, 'true');
                    showAlert('密码信息已更新', 'success');
                    window.location.href = '/password_admin';
                } else {
                    const errorData = await response.json();
                    showAlert('更新失败: ' + (errorData.error || '未知错误'), 'danger');
                }
            } catch (error) {
                console.error('更新密码错误:', error);
                showAlert('更新密码失败，请检查输入信息', 'danger');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // 添加事件监听器以清除输入框的错误状态
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        });
    </script>
{% endblock %}