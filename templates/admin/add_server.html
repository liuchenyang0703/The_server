{% extends 'admin/admin_layout.html' %}

{% block title %}添加服务器 - 服务器密码管理系统{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- 页面标题 -->
        <div class="page-header mb-4 text-center">
            <h1 class="h3">添加新服务器信息</h1>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form id="addServerForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="serverIp" class="form-label">服务器IP <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="serverIp" required>
                                <div class="invalid-feedback">请输入服务器IP</div>
                            </div>
                            <div class="mb-3">
                                <label for="serverOs" class="form-label">操作系统 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="serverOs" required>
                                <div class="invalid-feedback">请输入操作系统</div>
                            </div>
                            <div class="mb-3">
                                <label for="serverKernel" class="form-label">内核 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="serverKernel" required>
                                <div class="invalid-feedback">请输入内核</div>
                            </div>
                            <div class="mb-3">
                                <label for="serverGpu" class="form-label">显卡型号</label>
                                <input type="text" class="form-control" id="serverGpu">
                            </div>
                            <div class="mb-3">
                                <label for="serverGpuMem" class="form-label">单卡显存</label>
                                <input type="text" class="form-control" id="serverGpuMem">
                            </div>
                            <div class="mb-3">
                                <label for="serverRam" class="form-label">内存 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="serverRam" required>
                                <div class="invalid-feedback">请输入内存</div>
                            </div>
                            <div class="mb-3">
                                <label for="serverCpu" class="form-label">CPU型号 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="serverCpu" required>
                                <div class="invalid-feedback">请输入CPU型号</div>
                            </div>
                            <div class="mb-3">
                                <label for="serverCpuCores" class="form-label">CPU核数 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="serverCpuCores" required>
                                <div class="invalid-feedback">请输入CPU核数</div>
                            </div>
                            <div class="mb-3">
                                <label for="serverArch" class="form-label">系统架构 <span class="text-danger">*</span></label>
                                <select class="form-select" id="serverArch" required>
                                    <option value="">请选择系统架构</option>
                                    <option value="x86_64">x86_64</option>
                                    <option value="aarch64">aarch64</option>
                                </select>
                                <div class="invalid-feedback">请选择系统架构</div>
                            </div>
                            <div class="d-flex gap-2 justify-content-center">
                                <button type="button" class="btn btn-primary" id="saveServerBtn">
                                    <i class="bi bi-save me-1"></i> 保存
                                </button>
                                <a href="/server_admin" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left me-1"></i> 返回
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // 启用Bootstrap表单验证
        (function () {
            'use strict';
            window.addEventListener('load', function () {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
        
        document.getElementById('saveServerBtn').addEventListener('click', function() {
            const form = document.getElementById('addServerForm');
            
            // 触发表单验证
            form.classList.add('was-validated');
            
            if (!form.checkValidity()) {
                return;
            }
            
            const formData = {
                ip: document.getElementById('serverIp').value,
                os: document.getElementById('serverOs').value,
                kernel: document.getElementById('serverKernel').value,
                gpu_model: document.getElementById('serverGpu').value.trim() || '无显卡',
                gpu_memory: document.getElementById('serverGpuMem').value.trim() || '无显卡',
                ram: document.getElementById('serverRam').value,
                cpu_model: document.getElementById('serverCpu').value,
                cpu_cores: document.getElementById('serverCpuCores').value,
                architecture: document.getElementById('serverArch').value
            };
            
            // 添加加载状态
            const saveBtn = this;
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="bi bi-spinner bi-spin me-1"></i>保存中...';
            
            fetch('/api/servers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('添加服务器失败');
                }
            })
            .then(data => {
                showAlert('服务器添加成功', 'success');
                    setTimeout(() => {
                        window.location.href = '/server_admin';
                    }, 1500);
            })
            .catch(error => {
                console.error('添加服务器错误:', error);
                showAlert('添加服务器失败，请检查输入信息', 'danger');
            })
            .finally(() => {
                // 恢复按钮状态
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            });
        });

        // 添加事件监听器以清除输入框的错误状态
        const inputs = document.querySelectorAll('input[required]');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                this.classList.remove('is-invalid');
            });
        });
    </script>
{% endblock %}