{% extends 'admin/admin_layout.html' %}

{% block title %}服务器密码后台管理{% endblock %}

{% block content %}
    <div class="container-fluid">
        
        <div class="row">
        <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom">
                        <h5 class="card-title mb-0 text-center flex-grow-1">服务器密码后台管理</h5>
                        <a href="/add_password" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus-circle me-1"></i>添加新密码
                        </a>
                    </div>
                    <div class="card-body">
                        <!-- 搜索框 -->
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="passwordSearch" placeholder="按IP搜索服务器密码...">
                            <button class="btn btn-primary" id="searchBtn">
                                <i class="bi bi-search"></i>搜索
                            </button>
                            <button class="btn btn-secondary" id="resetBtn">
                                <i class="bi bi-arrow-repeat"></i>重置
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle" id="passwordTable">
                                <thead class="table-light">
                                    <tr>
                                        <!-- <th>ID</th> -->
                                        <th>IP</th>
                                        <th>端口</th>
                                        <th>普通用户</th>
                                        <th>普通用户密码</th>
                                        <th>管理员root密码</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="passwordTableBody">
                                    <!-- 密码列表将通过JavaScript动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <style>
        .user-password, .root-password {
            vertical-align: middle;
        }
    </style>
    <script>
        // 页面加载完成后直接加载密码列表
        document.addEventListener('DOMContentLoaded', function() {
            loadPasswordList();
        });

        // 移除密码显示/隐藏切换功能，所有密码直接显示明文
        
        // 获取密码列表
        function loadPasswordList(searchTerm = '') {
            let url = '/api/passwords';
            
            // 如果有搜索条件，使用搜索API
            if (searchTerm) {
                url = `/api/passwords/search/${searchTerm}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('passwordTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="8" class="text-center py-5">${searchTerm ? '未找到匹配的服务器密码' : '暂无密码信息'}</td>
                        `;
                        tbody.appendChild(row);
                    } else {
                        data.forEach(password => {
                            const row = document.createElement('tr');
                            // 检查是否是新增或修改的记录（这里使用简单的时间戳比较，实际应用中可以从服务器获取创建/修改时间）
                            const isNew = localStorage.getItem(`new_password_${password.id}`) === 'true';
                            if (isNew) {
                                row.classList.add('bg-info', 'bg-opacity-10');
                                // 30秒后自动移除新增标记
                                setTimeout(() => {
                                    localStorage.removeItem(`new_password_${password.id}`);
                                    row.classList.remove('bg-info', 'bg-opacity-10');
                                }, 30000);
                            }
                            row.innerHTML = `
                                <td>${password.inner_ip}</td>
                                <td>${password.port}</td>
                                <td>${password.username}</td>
                                <td class="user-password">${password.user_password}</td>
                                <td class="root-password">${password.root_password}</td>
                                <td>${password.outer_ip}</td>
                                <td class="text-center">
                                    <div class="action-buttons">
                                        <a href="/edit_password?id=${password.id}" class="btn btn-primary">
                                            <i class="bi bi-pencil"></i>编辑
                                        </a>
                                        <a href="/delete?id=${password.id}&type=password" class="btn btn-danger">
                                            <i class="bi bi-trash"></i>删除
                                        </a>
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('获取密码列表失败:', error);
                    showAlert('获取密码列表失败，请检查网络连接', 'danger');
                });
        }
        
        // 搜索功能
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('passwordSearch');
            const searchBtn = document.getElementById('searchBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', function() {
                const searchTerm = searchInput.value.trim();
                loadPasswordList(searchTerm);
            });
            
            // 重置按钮点击事件
            resetBtn.addEventListener('click', function() {
                searchInput.value = '';
                loadPasswordList();
            });
            
            // 回车键搜索
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = searchInput.value.trim();
                    loadPasswordList(searchTerm);
                }
            });
        });
    </script>
{% endblock %}